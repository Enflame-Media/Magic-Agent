name: E2E Tests

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'e2e/**'
      - 'package.json'
      - 'playwright.config.ts'
      - 'vite.config.ts'
      - '.github/workflows/e2e.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'src/**'
      - 'e2e/**'
      - 'package.json'
      - 'playwright.config.ts'
      - 'vite.config.ts'
      - '.github/workflows/e2e.yml'
  workflow_dispatch:
    inputs:
      update_snapshots:
        description: 'Update visual regression snapshots'
        required: false
        type: boolean
        default: false

defaults:
  run:
    working-directory: .

# Cancel previous runs on the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Playwright E2E Tests
  # ============================================
  e2e:
    name: Playwright E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        # Run tests in parallel across multiple shards
        shard: [1, 2, 3]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          cache-dependency-path: yarn.lock

      - name: Enable Corepack
        run: corepack enable

      - name: Install Dependencies
        run: yarn install --immutable

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium firefox webkit

      - name: Build Application
        run: yarn build:app

      - name: Run E2E Tests
        run: yarn test:e2e --shard=${{ matrix.shard }}/3
        env:
          CI: true
          # Test credentials (use secrets in production)
          E2E_TEST_EMAIL: ${{ secrets.E2E_TEST_EMAIL || 'admin@test.local' }}
          E2E_TEST_PASSWORD: ${{ secrets.E2E_TEST_PASSWORD || 'TestPassword123!' }}

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.shard }}
          path: playwright-report/
          retention-days: 30

      - name: Upload Test Artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-results-${{ matrix.shard }}
          path: |
            e2e-results/
            test-results/
          retention-days: 7

  # ============================================
  # Merge Reports
  # ============================================
  merge-reports:
    name: Merge E2E Reports
    needs: e2e
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          cache-dependency-path: yarn.lock

      - name: Download All Reports
        uses: actions/download-artifact@v4
        with:
          pattern: playwright-report-*
          path: all-reports/

      - name: Merge Reports
        run: |
          npx playwright merge-reports --reporter=html ./all-reports
        working-directory: ${{ github.workspace }}

      - name: Upload Merged Report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-merged
          path: playwright-report/
          retention-days: 30

      - name: Create Test Summary
        if: always()
        env:
          REF_NAME: ${{ github.ref_name }}
          COMMIT_SHA: ${{ github.sha }}
          E2E_RESULT: ${{ needs.e2e.result }}
        run: |
          echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: Playwright E2E Tests" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: $REF_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: $COMMIT_SHA" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$E2E_RESULT" == "success" ]; then
            echo "### Status: All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Status: Some tests failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Download the test artifacts for detailed failure information." >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # Visual Regression (Optional - Run on main only)
  # ============================================
  visual-regression:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          cache-dependency-path: yarn.lock

      - name: Enable Corepack
        run: corepack enable

      - name: Install Dependencies
        run: yarn install --immutable

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Build Application
        run: yarn build:app

      - name: Run Visual Regression Tests
        run: yarn test:e2e --grep "visual regression" --project=chromium
        env:
          CI: true
          E2E_TEST_EMAIL: ${{ secrets.E2E_TEST_EMAIL || 'admin@test.local' }}
          E2E_TEST_PASSWORD: ${{ secrets.E2E_TEST_PASSWORD || 'TestPassword123!' }}

      - name: Upload Visual Snapshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: visual-regression-snapshots
          path: |
            e2e/__snapshots__/
            e2e-results/
          retention-days: 14

      - name: Comment on PR with Visual Diff
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## Visual Regression Test Failed\n\nThere are visual differences detected. Please review the screenshots in the uploaded artifacts.\n\nTo update snapshots, run:\n```bash\nyarn test:e2e:update-snapshots\n```'
            })

  # ============================================
  # Accessibility Tests
  # ============================================
  accessibility:
    name: Accessibility Tests (axe-core)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          cache-dependency-path: yarn.lock

      - name: Enable Corepack
        run: corepack enable

      - name: Install Dependencies
        run: yarn install --immutable

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Build Application
        run: yarn build:app

      - name: Run Accessibility Tests
        run: yarn test:e2e --grep "Accessibility" --project=chromium
        env:
          CI: true
          E2E_TEST_EMAIL: ${{ secrets.E2E_TEST_EMAIL || 'admin@test.local' }}
          E2E_TEST_PASSWORD: ${{ secrets.E2E_TEST_PASSWORD || 'TestPassword123!' }}

      - name: Upload Accessibility Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-report
          path: playwright-report/
          retention-days: 14

      - name: Comment on PR with Accessibility Issues
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## Accessibility Test Failed\n\nAccessibility violations were detected. Please review the test report in the uploaded artifacts.\n\nCommon fixes:\n- Add missing `alt` attributes to images\n- Ensure form elements have associated labels\n- Check color contrast ratios\n- Add ARIA labels to interactive elements\n\nRun locally with:\n```bash\nyarn test:e2e --grep "Accessibility"\n```'
            })

  # ============================================
  # Update Visual Regression Baselines (Manual)
  # ============================================
  update-baselines:
    name: Update Visual Regression Baselines
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.update_snapshots == 'true'
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          cache-dependency-path: yarn.lock

      - name: Enable Corepack
        run: corepack enable

      - name: Install Dependencies
        run: yarn install --immutable

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Build Application
        run: yarn build:app

      - name: Generate Visual Regression Baselines
        run: yarn test:e2e:update-snapshots --project=chromium --grep "visual regression"
        env:
          CI: true
          E2E_TEST_EMAIL: ${{ secrets.E2E_TEST_EMAIL || 'admin@test.local' }}
          E2E_TEST_PASSWORD: ${{ secrets.E2E_TEST_PASSWORD || 'TestPassword123!' }}

      - name: Check for Changes
        id: check_changes
        run: |
          if [ -n "$(git status e2e/__snapshots__ --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Baseline changes detected:"
            git status e2e/__snapshots__ --porcelain
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No baseline changes detected"
          fi

      - name: Commit Baseline Updates
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add e2e/__snapshots__/
          git commit -m "chore: update visual regression baselines

          Generated by GitHub Actions workflow.
          Triggered by: ${{ github.actor }}
          Ref: ${{ github.ref }}"
          git push

      - name: Upload Snapshots Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-regression-baselines
          path: e2e/__snapshots__/
          retention-days: 30

      - name: Summary
        if: always()
        run: |
          echo "## Visual Regression Baseline Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "### Status: Baselines Updated" >> $GITHUB_STEP_SUMMARY
            echo "New baseline screenshots have been committed to the repository." >> $GITHUB_STEP_SUMMARY
          else
            echo "### Status: No Changes" >> $GITHUB_STEP_SUMMARY
            echo "No baseline changes were detected. Baselines are up to date." >> $GITHUB_STEP_SUMMARY
          fi
