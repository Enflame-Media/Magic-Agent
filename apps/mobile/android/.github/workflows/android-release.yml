# Copyright (c) 2024-2026 Enflame Media. All rights reserved.
#
# GitHub Actions release workflow for Happy Android
# Builds signed release APK/AAB and deploys to Google Play internal testing
#
# Uses Fastlane lanes for centralized build process management.
# Version code is auto-generated from git commit count (base 1000 + commit count).
#
# Security: All workflow_dispatch inputs are passed through env: blocks
# and referenced as shell variables to prevent command injection.
#
# Required GitHub Secrets:
#   KEYSTORE_FILE              - Base64-encoded release keystore
#   KEYSTORE_PASSWORD          - Keystore password
#   KEY_ALIAS                  - Key alias within the keystore
#   KEY_PASSWORD               - Key password
#   PLAY_SERVICE_ACCOUNT_JSON  - Google Play service account JSON key

name: Android Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version name (e.g., 1.2.0)'
        required: true
        type: string
      version_code:
        description: 'Version code override (leave empty for auto-increment from git commit count)'
        required: false
        type: string
        default: ''
      track:
        description: 'Google Play release track'
        required: true
        default: 'internal'
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production
      changelog:
        description: 'Release notes'
        required: false
        type: string
        default: 'Bug fixes and improvements.'

concurrency:
  group: android-release-${{ github.ref }}
  cancel-in-progress: false

env:
  JAVA_VERSION: "17"
  JAVA_DISTRIBUTION: "temurin"
  RUBY_VERSION: "3.2"
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true"
  BUNDLE_GEMFILE: fastlane/Gemfile
  FASTLANE_SKIP_UPDATE_CHECK: "1"
  FASTLANE_HIDE_CHANGELOG: "1"

jobs:
  # ---------------------------------------------------------------------------
  # Job: Run tests before release
  # ---------------------------------------------------------------------------
  test:
    name: Pre-release Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for git commit count version code

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: true

      - name: Set up Ruby and install Fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Run unit tests
        run: bundle exec fastlane test

      - name: Run lint checks
        run: bundle exec fastlane lint

  # ---------------------------------------------------------------------------
  # Job: Build signed release and deploy
  # ---------------------------------------------------------------------------
  release:
    name: Build & Deploy
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 45
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for git commit count version code

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: true

      - name: Set up Ruby and install Fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Decode keystore
        env:
          KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
        run: |
          echo "$KEYSTORE_FILE" | base64 --decode > app/release-keystore.jks

      - name: Compute version code
        id: version
        env:
          INPUT_VERSION_CODE: ${{ github.event.inputs.version_code }}
        run: |
          if [ -n "$INPUT_VERSION_CODE" ]; then
            echo "code=$INPUT_VERSION_CODE" >> "$GITHUB_OUTPUT"
            echo "Version code (manual override): $INPUT_VERSION_CODE"
          else
            COMMIT_COUNT=$(git rev-list --count HEAD)
            AUTO_CODE=$((1000 + COMMIT_COUNT))
            echo "code=$AUTO_CODE" >> "$GITHUB_OUTPUT"
            echo "Version code (auto): $AUTO_CODE (base 1000 + $COMMIT_COUNT commits)"
          fi

      - name: Set version code and build release
        env:
          KEYSTORE_FILE: ${{ github.workspace }}/app/release-keystore.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          FL_VERSION_CODE: ${{ steps.version.outputs.code }}
        run: |
          bundle exec fastlane set_version_code code:"$FL_VERSION_CODE"
          bundle exec fastlane build_release skip_version_code:true

      - name: Clean up keystore
        if: always()
        run: rm -f app/release-keystore.jks

      - name: Upload release APK
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: app/build/outputs/apk/release/*.apk
          retention-days: 90

      - name: Upload release AAB
        uses: actions/upload-artifact@v4
        with:
          name: release-aab
          path: app/build/outputs/bundle/release/*.aab
          retention-days: 90

      - name: Deploy to Google Play
        env:
          PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          bundle exec fastlane deploy_internal skip_build:true
        continue-on-error: true

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION_NAME: ${{ github.event.inputs.version }}
          VERSION_CODE: ${{ steps.version.outputs.code }}
          CHANGELOG: ${{ github.event.inputs.changelog }}
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
          gh release create "android/v${VERSION_NAME}" \
            --title "Happy Android v${VERSION_NAME} (${VERSION_CODE})" \
            --notes "${CHANGELOG:-Bug fixes and improvements.}" \
            "$APK_PATH"

      - name: Upload mapping file
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mapping
          path: app/build/outputs/mapping/release/mapping.txt
          retention-days: 365
