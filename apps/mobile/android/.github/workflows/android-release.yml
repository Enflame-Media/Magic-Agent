# Copyright (c) 2024-2026 Enflame Media. All rights reserved.
#
# GitHub Actions release workflow for Happy Android
# Builds signed release APK/AAB and deploys to Google Play internal testing
#
# Security: All workflow_dispatch inputs are passed through env: blocks
# and referenced as shell variables to prevent command injection.
#
# Required GitHub Secrets:
#   KEYSTORE_FILE              - Base64-encoded release keystore
#   KEYSTORE_PASSWORD          - Keystore password
#   KEY_ALIAS                  - Key alias within the keystore
#   KEY_PASSWORD               - Key password
#   PLAY_SERVICE_ACCOUNT_JSON  - Google Play service account JSON key

name: Android Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version name (e.g., 1.2.0)'
        required: true
        type: string
      version_code:
        description: 'Version code (integer, e.g., 12)'
        required: true
        type: string
      track:
        description: 'Google Play release track'
        required: true
        default: 'internal'
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production
      changelog:
        description: 'Release notes'
        required: false
        type: string
        default: 'Bug fixes and improvements.'

concurrency:
  group: android-release-${{ github.ref }}
  cancel-in-progress: false

env:
  JAVA_VERSION: "17"
  JAVA_DISTRIBUTION: "temurin"
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true"

jobs:
  # ---------------------------------------------------------------------------
  # Job: Run tests before release
  # ---------------------------------------------------------------------------
  test:
    name: Pre-release Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Run unit tests
        run: ./gradlew testReleaseUnitTest --stacktrace

      - name: Run lint checks
        run: ./gradlew lintRelease --stacktrace

  # ---------------------------------------------------------------------------
  # Job: Build signed release and deploy
  # ---------------------------------------------------------------------------
  release:
    name: Build & Deploy
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 45
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Decode keystore
        env:
          KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
        run: |
          echo "$KEYSTORE_FILE" | base64 --decode > app/release-keystore.jks

      - name: Build signed release APK
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file="$PWD/app/release-keystore.jks" \
            -Pandroid.injected.signing.store.password="$KEYSTORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$KEY_PASSWORD" \
            --stacktrace

      - name: Build signed release AAB
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          ./gradlew bundleRelease \
            -Pandroid.injected.signing.store.file="$PWD/app/release-keystore.jks" \
            -Pandroid.injected.signing.store.password="$KEYSTORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$KEY_PASSWORD" \
            --stacktrace

      - name: Clean up keystore
        if: always()
        run: rm -f app/release-keystore.jks

      - name: Upload release APK
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: app/build/outputs/apk/release/*.apk
          retention-days: 90

      - name: Upload release AAB
        uses: actions/upload-artifact@v4
        with:
          name: release-aab
          path: app/build/outputs/bundle/release/*.aab
          retention-days: 90

      - name: Upload to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.enflame.happy
          releaseFiles: app/build/outputs/bundle/release/*.aab
          track: ${{ github.event.inputs.track }}
          whatsNewDirectory: fastlane/metadata/android/en-US/changelogs
          status: completed
        continue-on-error: true

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION_NAME: ${{ github.event.inputs.version }}
          CHANGELOG: ${{ github.event.inputs.changelog }}
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
          gh release create "android/v${VERSION_NAME}" \
            --title "Happy Android v${VERSION_NAME}" \
            --notes "${CHANGELOG:-Bug fixes and improvements.}" \
            "$APK_PATH"

      - name: Upload mapping file
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mapping
          path: app/build/outputs/mapping/release/mapping.txt
          retention-days: 365
